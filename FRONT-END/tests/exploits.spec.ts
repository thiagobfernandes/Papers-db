import { test, expect } from "@playwright/test";
import { loginViaUI } from "./utils/auth";
import { goToExploitsTab } from "./utils/got-to-tabs";

test.describe.serial("Cria√ß√£o de Exploits ap√≥s login", () => {
  test("deve fazer login e criar exploit com sucesso", async ({ page }) => {
    await loginViaUI(page);
    await page.reload();

    await goToExploitsTab(page);

    await page.getByRole("button", { name: "Criar novo" }).click();
    await expect(page.getByRole("dialog")).toBeVisible();

    await page.locator('input[name="title"]').fill("Exploit via login real");

    const select = page.locator(
      '.ant-form-item:has-text("Verificado") .ant-select'
    );
    await expect(select).toBeVisible();
    await select.click();

    await page.locator('input[name="type"]').fill("PHP");

    await page
      .locator('.ant-form-item:has-text("Plataforma") .ant-select')
      .click();
    await page
      .locator(".ant-select-item-option-content", { hasText: "PHP" })
      .click();

    await page.getByRole("button", { name: "Salvar" }).click();

    await expect(page.getByRole("dialog")).not.toBeVisible();
    await expect(page.getByText(/exploit criado com sucesso/i)).toBeVisible();
  });

  test("deve exibir mensagens de erro ao tentar criar um exploit com campos obrigat√≥rios vazios", async ({
    page,
  }) => {
    await loginViaUI(page);
    await page.reload();

    await goToExploitsTab(page);

    await page.getByRole("button", { name: "Criar novo" }).click();
    await expect(page.getByRole("dialog")).toBeVisible();

    await page.getByRole("button", { name: "Salvar" }).click();

    await expect(page.getByText("T√≠tulo obrigat√≥rio")).toHaveCount(1);
    await expect(page.getByText("Tipo obrigat√≥rio")).toBeVisible();
    await expect(page.getByText("Plataforma obrigat√≥ria")).toBeVisible();
  });

  test("deve listar os exploits na tabela", async ({ page }) => {
    await loginViaUI(page);
    await page.reload();

    await goToExploitsTab(page);

    const rows = page.locator("table tbody tr");
    await expect(await rows.count()).toBeGreaterThan(0);
  });

  test("deve mostrar erro ao tentar salvar edi√ß√£o com t√≠tulo vazio", async ({
    page,
  }) => {
    await loginViaUI(page);
    await page.reload();

    await goToExploitsTab(page);

    const editButton = page.getByRole("button", { name: "‚úèÔ∏è" }).first();
    await expect(editButton).toBeVisible();
    await editButton.click();

    const modal = page.getByRole("dialog", { name: /editar exploit/i });
    await expect(modal).toBeVisible({ timeout: 10000 });

    await page.locator('input[name="title"]').fill("");
    await page.getByRole("button", { name: "Salvar" }).click();

    await expect(page.getByText("T√≠tulo obrigat√≥rio")).toBeVisible();
  });

  test("deve permitir editar um exploit existente", async ({ page }) => {
    await loginViaUI(page);
    await page.reload();

    await goToExploitsTab(page);

    const editButton = page.getByRole("button", { name: "‚úèÔ∏è" }).first();
    await expect(editButton).toBeVisible();
    await editButton.click();

    const modal = page.getByRole("dialog", { name: /editar exploit/i });
    await expect(modal).toBeVisible();

    const titleInput = page.locator('input[name="title"]');
    await titleInput.fill("Exploit editado via E2E");

    await page.getByRole("button", { name: "Salvar" }).click();

    await expect(modal).not.toBeVisible();
    await expect(
      page.getByText(/exploit atualizado com sucesso/i)
    ).toBeVisible();

    await expect(page.getByText("Exploit editado via E2E")).toBeVisible();
  });

  test("deve permitir deletar um exploit existente", async ({ page }) => {
    await loginViaUI(page);
    await page.reload();

    await goToExploitsTab(page);

    const deleteButton = page.getByRole("button", { name: "üóëÔ∏è" }).first();
    await expect(deleteButton).toBeVisible();
    await deleteButton.click();

    const confirmModal = page.getByRole("dialog", {
      name: /confirmar exclus√£o/i,
    });
    await expect(confirmModal).toBeVisible();

    await page.getByRole("button", { name: "Sim, deletar" }).click();
    await expect(page.getByText(/exploit deletado com sucesso/i)).toBeVisible();
  });
});
